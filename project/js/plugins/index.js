(function(c){typeof define=="function"&&define.amd?define(c):c()})(function(){"use strict";var P=Object.defineProperty;var q=(c,u,m)=>u in c?P(c,u,{enumerable:!0,configurable:!0,writable:!0,value:m}):c[u]=m;var l=(c,u,m)=>(q(c,typeof u!="symbol"?u+"":u,m),m);let c=!1;function u(){c=!0,Input.clear(),TouchInput.clear()}function m(){c=!1}const w={Input:{_onKeyDown:Input._onKeyDown,_onKeyUp:Input._onKeyUp,_onLostFocus:Input._onLostFocus},TouchInput:{_onMouseDown:TouchInput._onMouseDown,_onMouseMove:TouchInput._onMouseMove,_onMouseUp:TouchInput._onMouseUp,_onWheel:TouchInput._onWheel,_onTouchStart:TouchInput._onTouchStart,_onTouchMove:TouchInput._onTouchMove,_onTouchEnd:TouchInput._onTouchEnd,_onTouchCancel:TouchInput._onTouchCancel,_onLostFocus:TouchInput._onLostFocus}};for(let n in w.Input)Input[n]=function(){c||w.Input[n].apply(this,arguments)};for(let n in w.TouchInput)TouchInput[n]=function(){c||w.TouchInput[n].apply(this,arguments)};const z="";let h;__releaseEnv?h="https://release.cloudsave.newcenturyfans.cn:7259":__buildEnv?h="https://test.cloudsave.newcenturyfans.cn:7305":h="http://localhost:7305";async function L(){return fetch(`${h}/ping`).then(n=>n.text()).then(n=>n==="pong").catch(n=>!1)}async function x(n){const e=new FormData;return e.append("email",n),fetch(`${h}/register/request_email_confirm`,{method:"POST",body:e}).then(t=>t.json())}async function k(n,e){const t=new FormData;return t.append("email",n),t.append("verifyCode",e),fetch(`${h}/register/login`,{method:"POST",body:t}).then(o=>o.json())}async function W(n,e){const t=new FormData;return t.append("email",n),fetch(`${h}/quick_login`,{method:"POST",body:t,headers:{"x-auth-token":e}}).then(o=>o.json())}async function b(n,e,t){const o=new FormData;return o.append("savefile",t),fetch(`${h}/upload_cloudsave`,{method:"POST",body:o,headers:{"x-auth-token":e,"x-user-email":n}}).then(a=>a.json())}async function M(n,e){return fetch(`${h}/download_cloudsave`,{method:"POST",headers:{"x-auth-token":e,"x-user-email":n}}).then(t=>t.json())}class D{constructor(e){l(this,"container");l(this,"title");l(this,"loding",!1);l(this,"options");this.options=e}createContainer(){this.container=document.createElement("div"),this.container.id="cloudsave_container",this.container.innerHTML=`<svg id="${this.createId("close")}" width="24" height="24" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M42 42L33 33M6 6L15 15L6 6Z" stroke="#333" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/><path d="M6 42L15 33M42 6L33 15L42 6Z" stroke="#333" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/><path d="M24 29C26.7614 29 29 26.7614 29 24C29 21.2386 26.7614 19 24 19C21.2386 19 19 21.2386 19 24C19 26.7614 21.2386 29 24 29Z" fill="none" stroke="#333" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/></svg>`;const e=this.container.querySelector(`#${this.createId("close")}`);e.onclick=()=>{var t,o;T(),(o=(t=this.options).onClose)==null||o.call(t)},document.body.appendChild(this.container)}createTitle(){this.title=document.createElement("div"),this.title.textContent="云存档登录",this.title.id=this.createId("title"),this.container.appendChild(this.title)}createForm(){const e=document.createElement("form");e.id=this.createId("form"),e.innerHTML=`   
      <div class="${this.createId("input_containter")}">
        <input type="text" autocomplete="off" name="account" placeholder="输入邮箱" class="${this.createId("input")}" id="${this.createId("account")}">
        <div id="${this.createId("send_email")}">发送验证码</div>
        <input type="text" autocomplete="off" name="verifyCode" placeholder="输入验证码" class="${this.createId("input")}" id="${this.createId("verifyCode")}">
      </div> 
      <div id="${this.createId("login")}">登&nbsp;&nbsp;录</div>
    `;const t=e.querySelector(`#${this.createId("account")}`),o=e.querySelector(`#${this.createId("verifyCode")}`),a=e.querySelector(`#${this.createId("send_email")}`);s.getLocalUserEmail()&&(t.value=s.getLocalUserEmail()),a.onclick=()=>{this.loding||(a.innerHTML="处理中...",this.loding=!0,a.classList.add("loading"),x(t.value).then(r=>{r.code===0?alert("验证码已发送至邮箱"):alert(r.info)}).catch(r=>{alert("发送验证码失败，请稍后再试")}).finally(()=>{a.classList.remove(this.createId("loading")),this.loding=!1,a.innerHTML="发送验证码"}))};const i=e.querySelector(`#${this.createId("login")}`);i.onclick=()=>{if(this.loding)return;i.innerHTML="处理中...",this.loding=!0,i.classList.add("loading");const r=t.value;k(r,o.value).then(d=>{var f,v;d.code===0?(alert("登录成功"),s.setAuthToken(d.token),s.setLocalUserEmail(r),(v=(f=this.options).onLoginSuccess)==null||v.call(f)):alert(d.info)}).catch(d=>{alert("登录失败，请稍后再试")}).finally(()=>{i.classList.remove(this.createId("loading")),this.loding=!1,i.innerHTML="登&nbsp;&nbsp;录"})},this.container.appendChild(e)}render(){this.createContainer(),this.createTitle(),this.createForm()}createId(e){return"cloudsave_"+e}}function E(n={}){u(),new D(n).render()}function T(){const n=document.getElementById("cloudsave_container");n&&document.body.removeChild(n),m()}for(var p="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",g=typeof Uint8Array>"u"?[]:new Uint8Array(256),_=0;_<p.length;_++)g[p.charCodeAt(_)]=_;var A=function(n){var e=new Uint8Array(n),t,o=e.length,a="";for(t=0;t<o;t+=3)a+=p[e[t]>>2],a+=p[(e[t]&3)<<4|e[t+1]>>4],a+=p[(e[t+1]&15)<<2|e[t+2]>>6],a+=p[e[t+2]&63];return o%3===2?a=a.substring(0,a.length-1)+"=":o%3===1&&(a=a.substring(0,a.length-2)+"=="),a},$=function(n){var e=n.length*.75,t=n.length,o,a=0,i,r,d,f;n[n.length-1]==="="&&(e--,n[n.length-2]==="="&&e--);var v=new ArrayBuffer(e),I=new Uint8Array(v);for(o=0;o<t;o+=4)i=g[n.charCodeAt(o)],r=g[n.charCodeAt(o+1)],d=g[n.charCodeAt(o+2)],f=g[n.charCodeAt(o+3)],I[a++]=i<<2|r>>4,I[a++]=(r&15)<<4|d>>2,I[a++]=(d&3)<<6|f&63;return v};class U{constructor(){l(this,"enabledCloudSave",!0);l(this,"onlineState","offline");l(this,"cloudSaveRefreshState","off");l(this,"cloudSaveInfo",null);l(this,"cloudSaveData",null)}openLoginAndRegisterWindow(e={}){E({onLoginSuccess:()=>{var t,o;this.onlineState="login",(t=e.onLoginSuccess)==null||t.call(e),T(),(o=e.onClose)==null||o.call(e)},onClose:()=>{var t;(t=e.onClose)==null||t.call(e)}})}getAuthToken(){return localStorage.getItem("authToken")}hasAuthToken(){return localStorage.getItem("authToken")!==null}setAuthToken(e){localStorage.setItem("authToken",e)}clearAuthToken(){localStorage.removeItem("authToken")}setLocalUserEmail(e){localStorage.setItem("userEmail",e)}getLocalUserEmail(){return localStorage.getItem("userEmail")}clearLocalUserEmail(){localStorage.removeItem("userEmail")}async refreshOnlineState(){if(!await L()){this.onlineState="offline";return}this.onlineState="notLogin";const t=this.getLocalUserEmail(),o=this.getAuthToken();if(t&&o){const a=await W(t,o);a.code===1?this.clearAuthToken():a.code===0&&(this.onlineState="login")}}makeCloudSaveInfo(){return DataManager.makeSavefileInfo()}async makeCloudSaveData(){const e=DataManager.makeSaveContents();if(__buildEnv){const t=await StorageManager.encodeSaveData(e);return A(t)}else return StorageManager.objectToJson(e).then(t=>StorageManager.jsonToZip(t))}async saveToCloud(){if(this.onlineState!=="login")return;const e=this.makeCloudSaveInfo();DataManager._globalInfo[1]=e,DataManager.saveGlobalInfo();const t=await this.makeCloudSaveData(),o={cloudSaveInfo:JSON.stringify(e),cloudSaveData:t},i=new TextEncoder().encode(JSON.stringify(o)),r=new Blob([i]),d=this.getLocalUserEmail(),f=this.getAuthToken();await b(d,f,r)}async loadFromCloud(){if(this.onlineState!=="login")return;const e=this.getLocalUserEmail(),t=this.getAuthToken(),o=await M(e,t);if(o.code!==0)return;var i="data:application/octet-binary;base64,"+o.data;const r=await fetch(i).then(v=>v.arrayBuffer()),f=new TextDecoder().decode(r);return JSON.parse(f)}async refreshCloudSave(){this.cloudSaveRefreshState="fetching",this.cloudSaveData=null,this.cloudSaveInfo=null;try{const e=await this.loadFromCloud();if(!e){this.cloudSaveRefreshState="off";return}this.cloudSaveData=e.cloudSaveData,this.cloudSaveInfo=JSON.parse(e.cloudSaveInfo),this.cloudSaveRefreshState="off"}catch(e){console.error(e),this.cloudSaveRefreshState="off"}}isCloudSaveRefreshFinished(){return this.cloudSaveRefreshState==="off"}isCloudSaveDataPrepared(){return this.cloudSaveData!==null}async loadGame(){let e;if(!__buildEnv)e=await StorageManager.zipToJson(this.cloudSaveData).then(t=>StorageManager.jsonToObject(t));else{const t=$(this.cloudSaveData);e=await StorageManager.decodeSaveData(t)}return DataManager.createGameObjects(),DataManager.extractSaveContents(e),DataManager.correctDataErrors(),0}async saveGame(){return await this.saveToCloud(),0}logout(){this.clearAuthToken(),this.clearLocalUserEmail(),this.onlineState="notLogin"}}const s=new U;class C extends Scene_MenuBase{constructor(){super(...arguments);l(this,"_commandWindow");l(this,"_serveStatusWindow")}create(){super.create(),this.createTitle(),this.createStatusWindow(),this.createCloudServeCommandWindow()}start(){super.start(),s.refreshOnlineState().then(()=>this.refresh())}refresh(){this._serveStatusWindow.refresh(),this._commandWindow.refresh()}createTitle(){const t=new PIXI.TextStyle({fontFamily:"Arial",fontSize:36,fontWeight:"bold",fill:["#ffffff","#ffffff"],stroke:"#000000",strokeThickness:5,dropShadow:!1,dropShadowColor:"#000000",dropShadowBlur:2,dropShadowAngle:Math.PI/6,dropShadowDistance:6,wordWrap:!0,wordWrapWidth:440,lineJoin:"round"}),o=new PIXI.Text("云存档",t);o.x=Graphics.width/2-o.width/2,this.addChild(o)}createStatusWindow(){const t=this.mainAreaTop()+50,o=300,a=Graphics.width/2-o/2,i=new Rectangle(a,t,o,200),r=new R(i);this._serveStatusWindow=r,this.addWindow(r)}createCloudServeCommandWindow(){const t=this.mainAreaTop()+300,o=Graphics.width/2-400/2,a=new Rectangle(o,t,400,400),i=new F(a);i.setHandler("pingServer",this.commandPingServer.bind(this)),i.setHandler("login",this.commandLogin.bind(this)),i.setHandler("logout",this.commandLogout.bind(this)),i.setHandler("cancel",this.popScene.bind(this)),this.addWindow(i),this._commandWindow=i}async commandPingServer(){await s.refreshOnlineState(),this.refresh(),this._commandWindow.activate()}commandLogin(){s.openLoginAndRegisterWindow({onClose:()=>{this.refresh(),this._commandWindow.activate()}})}commandLogout(){s.logout(),this.refresh(),this._commandWindow.activate()}}class F extends Window_Command{makeCommandList(){switch(s.onlineState){case"offline":this.addCommand("连接服务器","pingServer");break;case"notLogin":this.addCommand("登录","login");break;case"login":this.addCommand("切换账号","login"),this.addCommand("下线","logout");break}}}const B={offline:33,notLogin:34,login:35},O={offline:"离线",notLogin:"未登录",login:"已登录"};class R extends Window_Base{constructor(e){super(e),this.refresh()}refresh(){this.contents.clear(),this.drawStatus(),this.drawUser()}drawUser(){const e=s.getLocalUserEmail();if(e){const t=`${e}`;this.drawTextEx(t,0,0,this.width)}}drawStatus(){const e=s.onlineState,t=O[e],o=B[s.onlineState],a=`当前状态：${t} \\I[${o}]`;this.contents.fontSize=24,this.drawTextEx(a,0,30,this.width),!__buildEnv&&e==="offline"&&this.drawTextEx(`当前为开发环境
无法连接远程服务器`,0,65,this.width)}}const y={Scene_Title:{create:Scene_Title.prototype.create},Window_TitleCommand:{makeCommandList:Window_TitleCommand.prototype.makeCommandList},DataManager:{isAnySavefileExists:DataManager.isAnySavefileExists}};Scene_Title.prototype.create=function(){y.Scene_Title.create.call(this),this._commandWindow.setHandler("cloudSave",()=>SceneManager.push(C))},Scene_Title.prototype.createCloudSaveButton=function(){this._saveButton=new H,this.addChild(this._saveButton)},Scene_Title.prototype.commandWindowRect=function(){const n=$dataSystem.titleCommandWindow.offsetX,e=$dataSystem.titleCommandWindow.offsetY,t=this.mainCommandWidth(),o=this.calcWindowHeight(4,!0),a=(Graphics.boxWidth-t)/2+n,i=Graphics.boxHeight-o-96+e;return new Rectangle(a,i,t,o)};const j={offline:33,notLogin:34,login:35};class H extends Sprite_Clickable{constructor(){super();l(this,"_state");this.updateState()}update(){super.update(),this.updateState()}updateState(){s.onlineState!==this._state&&(this._state=s.onlineState,this.refresh())}refresh(){this.bitmap=ImageManager.loadSystem("IconSet");const t=j[this._state],o=ImageManager.iconWidth,a=ImageManager.iconHeight,i=t%16*o,r=Math.floor(t/16)*a;this.setFrame(i,r,o,a)}onClick(){SceneManager.push(C)}}Window_TitleCommand.prototype.makeCommandList=function(){y.Window_TitleCommand.makeCommandList.call(this),this.addCommand("云存档","cloudSave")},DataManager.isAnySavefileExists=function(){return y.DataManager.isAnySavefileExists.call(this)||s.onlineState==="login"};function G(n,e){const t=n.prototype;for(const o in e)t[o]=e[o]}const S={Scene_File:{createListWindow:Scene_File.prototype.createListWindow},Scene_Load:{executeLoad:Scene_Load.prototype.executeLoad},Scene_Save:{executeSave:Scene_Save.prototype.executeSave},Window_SavefileList:{initialize:Window_SavefileList.prototype.initialize,maxItems:Window_SavefileList.prototype.maxItems,indexToSavefileId:Window_SavefileList.prototype.indexToSavefileId,savefileIdToIndex:Window_SavefileList.prototype.savefileIdToIndex,isEnabled:Window_SavefileList.prototype.isEnabled}};Scene_File.prototype.createListWindow=function(){S.Scene_File.createListWindow.call(this),this._listWindow.setCloudSave(!0)},G(Window_SavefileList,{initialize(n){S.Window_SavefileList.initialize.call(this,n),this._cloudSave=s.enabledCloudSave,s.refreshCloudSave()},setCloudSave(n){this._cloudSave=n,this.refresh()},maxItems(){return S.Window_SavefileList.maxItems.call(this)-(this._cloudSave?0:1)},indexToSavefileId(n){return S.Window_SavefileList.indexToSavefileId.call(this,n)+(this._cloudSave?0:1)},savefileIdToIndex(n){return S.Window_SavefileList.savefileIdToIndex.call(this,n)-(this._cloudSave?0:1)},isEnabled(n){return this._cloudSave&&n===1?s.isCloudSaveRefreshFinished()?this._mode==="save"?!0:s.isCloudSaveDataPrepared():!1:S.Window_SavefileList.isEnabled.call(this,n)}}),Scene_Load.prototype.executeLoad=function(n){n===1&&s.enabledCloudSave?s.loadGame().then(()=>this.onLoadSuccess()).catch(()=>this.onLoadFailure()):S.Scene_Load.executeLoad.call(this,n)},Scene_Save.prototype.executeSave=function(n){n===1&&s.enabledCloudSave?($gameSystem.setSavefileId(n),$gameSystem.onBeforeSave(),s.saveGame().then(()=>this.onSaveSuccess()).catch(()=>this.onSaveFailure())):S.Scene_Save.executeSave.call(this,n)},DataManager.removeInvalidGlobalInfo=function(){const n=this._globalInfo;for(const e of n){const t=n.indexOf(e);t!==1&&(this.savefileExists(t)||delete n[t])}},console.log("整合插件加载完成! ")});
